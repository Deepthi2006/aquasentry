<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaCopilot - AquaSentry Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .chat-container {
            height: calc(100vh - 280px);
            min-height: 400px;
        }
        .message-user {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }
        .message-bot {
            background: #f1f5f9;
            color: #1e293b;
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="water-theme-bg min-h-screen">
    <nav class="water-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
                    </svg>
                    <span class="text-white font-bold text-xl">AquaSentry Live</span>
                </div>
                <div class="flex items-center gap-6">
                    <a href="/dashboard" class="nav-link">Dashboard</a>
                    <a href="/alerts" class="nav-link">Alerts</a>
                    <a href="/copilot" class="nav-link active">AquaCopilot</a>
                    <a href="/vision" class="nav-link">Vision AI</a>
                    <a href="/map" class="nav-link">Map</a>
                    <a href="/maintenance" class="nav-link">Maintenance</a>
                    <button onclick="logout()" class="nav-link text-white/80 hover:text-white">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-slate-800 flex items-center gap-3">
                <svg class="w-8 h-8 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                AquaCopilot
            </h1>
            <p class="text-slate-500 mt-1">AI-powered assistant for water utility officers</p>
        </div>

        <div class="water-card">
            <div class="p-4 border-b border-slate-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                        </svg>
                    </div>
                    <div>
                        <div class="font-semibold text-slate-800">AquaCopilot AI</div>
                        <div class="text-sm text-emerald-600 flex items-center gap-1">
                            <span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
                            Online - Ready to assist
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-messages" class="chat-container overflow-y-auto p-4 space-y-4">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                    </div>
                    <div class="message-bot rounded-2xl rounded-tl-none px-4 py-3 max-w-[80%]">
                        <p>Hello! I'm AquaCopilot, your AI assistant for water tank monitoring and management.</p>
                        <p class="mt-2">I can help you with:</p>
                        <ul class="mt-1 ml-4 list-disc text-sm">
                            <li>Tank status and water quality analysis</li>
                            <li>Alert interpretation and recommendations</li>
                            <li>Maintenance scheduling advice</li>
                            <li>BIS compliance and Jal Jeevan Mission guidelines</li>
                            <li>Generating reports for supervisors</li>
                        </ul>
                        <p class="mt-2 text-sm text-slate-600">How can I assist you today?</p>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200">
                <div class="flex gap-3">
                    <input 
                        type="text" 
                        id="chat-input" 
                        placeholder="Ask AquaCopilot about tanks, alerts, maintenance..." 
                        class="flex-1 px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-sky-500 outline-none"
                        onkeypress="if(event.key === 'Enter') sendMessage()"
                    >
                    <button 
                        onclick="sendMessage()" 
                        class="px-6 py-3 bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-xl hover:from-sky-600 hover:to-blue-700 transition-all flex items-center gap-2"
                    >
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                        Send
                    </button>
                </div>
                <div class="mt-3 flex flex-wrap gap-2">
                    <button onclick="quickQuery('What tanks need immediate attention?')" class="px-3 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 rounded-full text-slate-700">
                        Critical tanks?
                    </button>
                    <button onclick="quickQuery('Summarize today\\'s alerts')" class="px-3 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 rounded-full text-slate-700">
                        Alert summary
                    </button>
                    <button onclick="quickQuery('Which tanks need cleaning soon?')" class="px-3 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 rounded-full text-slate-700">
                        Maintenance due
                    </button>
                    <button onclick="quickQuery('What is the overall system health?')" class="px-3 py-1.5 text-sm bg-slate-100 hover:bg-slate-200 rounded-full text-slate-700">
                        System health
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { checkAuth, logout } from '/static/js/auth.js';
        checkAuth();
        window.logout = logout;
    </script>
    <script>
        let conversationContext = '';

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;

            input.value = '';
            addMessage(query, 'user');
            showTyping();

            try {
                const response = await fetch('/api/ai/copilot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, context: conversationContext })
                });

                const data = await response.json();
                hideTyping();

                if (data.success) {
                    addMessage(data.response, 'bot');
                    conversationContext = query + '\n' + data.response.substring(0, 500);
                } else {
                    addMessage(data.error || 'Sorry, I encountered an error. Please try again.', 'bot');
                }
            } catch (error) {
                hideTyping();
                addMessage('Connection error. Please check your network and try again.', 'bot');
            }
        }

        function quickQuery(query) {
            document.getElementById('chat-input').value = query;
            sendMessage();
        }

        function addMessage(text, type) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `flex items-start gap-3 ${type === 'user' ? 'flex-row-reverse' : ''}`;
            
            const iconBg = type === 'user' ? 'from-emerald-500 to-green-600' : 'from-sky-500 to-blue-600';
            const iconSvg = type === 'user' 
                ? '<svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'
                : '<svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>';
            
            const messageClass = type === 'user' ? 'message-user rounded-tr-none' : 'message-bot rounded-tl-none';
            
            const formattedText = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br ${iconBg} flex items-center justify-center flex-shrink-0">
                    ${iconSvg}
                </div>
                <div class="${messageClass} rounded-2xl px-4 py-3 max-w-[80%]">
                    ${formattedText}
                </div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping() {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex items-start gap-3';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
                </div>
                <div class="message-bot rounded-2xl rounded-tl-none px-4 py-3">
                    <div class="typing-indicator flex gap-1">
                        <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        window.sendMessage = sendMessage;
        window.quickQuery = quickQuery;
    </script>
</body>
</html>
