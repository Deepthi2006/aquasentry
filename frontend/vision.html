<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision AI - AquaSentry Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .upload-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #0ea5e9;
            background: rgba(14, 165, 233, 0.05);
        }
        .severity-none { background: #dcfce7; color: #166534; }
        .severity-low { background: #fef3c7; color: #92400e; }
        .severity-moderate { background: #fed7aa; color: #9a3412; }
        .severity-high { background: #fecaca; color: #991b1b; }
        .severity-severe { background: #fee2e2; color: #7f1d1d; border: 2px solid #ef4444; }
    </style>
</head>
<body class="water-theme-bg min-h-screen">
    <nav class="water-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
                    </svg>
                    <span class="text-white font-bold text-xl">AquaSentry Live</span>
                </div>
                <div class="flex items-center gap-6">
                    <a href="/dashboard" class="nav-link">Dashboard</a>
                    <a href="/alerts" class="nav-link">Alerts</a>
                    <a href="/copilot" class="nav-link">AquaCopilot</a>
                    <a href="/vision" class="nav-link active">Vision AI</a>
                    <a href="/map" class="nav-link">Map</a>
                    <a href="/maintenance" class="nav-link">Maintenance</a>
                    <button onclick="logout()" class="nav-link text-white/80 hover:text-white">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-slate-800 flex items-center gap-3">
                <svg class="w-8 h-8 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Vision AI Water Analysis
            </h1>
            <p class="text-slate-500 mt-1">Upload water sample or tank images for AI-powered contamination detection</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="water-card p-6">
                <h2 class="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Upload Image
                </h2>
                
                <div 
                    id="upload-zone" 
                    class="upload-zone rounded-xl p-8 text-center cursor-pointer"
                    onclick="document.getElementById('file-input').click()"
                    ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)"
                    ondrop="handleDrop(event)"
                >
                    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                    <svg class="w-16 h-16 mx-auto text-slate-400 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <p class="text-slate-600 font-medium">Click to upload or drag and drop</p>
                    <p class="text-sm text-slate-500 mt-1">Supports: JPG, PNG, WEBP (max 10MB)</p>
                </div>

                <div id="preview-container" class="hidden mt-4">
                    <img id="image-preview" class="w-full rounded-lg max-h-64 object-contain bg-slate-100">
                    <div class="mt-3 flex gap-2">
                        <select id="tank-select" class="flex-1 px-3 py-2 border border-slate-300 rounded-lg">
                            <option value="">Associate with tank (optional)</option>
                        </select>
                    </div>
                </div>

                <div class="mt-4 space-y-3">
                    <button 
                        id="analyze-water-btn"
                        onclick="analyzeWater()"
                        class="w-full px-4 py-3 bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-xl hover:from-sky-600 hover:to-blue-700 transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                        disabled
                    >
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
                        </svg>
                        Analyze Water Quality
                    </button>
                    <button 
                        id="analyze-infra-btn"
                        onclick="analyzeInfrastructure()"
                        class="w-full px-4 py-3 bg-gradient-to-r from-slate-600 to-slate-700 text-white rounded-xl hover:from-slate-700 hover:to-slate-800 transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                        disabled
                    >
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Analyze Infrastructure
                    </button>
                </div>
            </div>

            <div class="water-card p-6">
                <h2 class="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    Analysis Results
                </h2>

                <div id="results-container">
                    <div id="results-placeholder" class="text-center py-12 text-slate-500">
                        <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <p>Upload an image and click analyze to see results</p>
                    </div>
                    
                    <div id="results-loading" class="hidden text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-slate-600">Analyzing image with Vision AI...</p>
                        <p class="text-sm text-slate-500 mt-1">This may take a few seconds</p>
                    </div>

                    <div id="results-content" class="hidden space-y-4"></div>
                </div>
            </div>
        </div>

        <div class="mt-6 water-card p-6">
            <h2 class="text-xl font-semibold text-slate-800 mb-4">How Vision AI Helps Government Water Utilities</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-emerald-50 rounded-lg">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center mb-3">
                        <svg class="w-5 h-5 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <h3 class="font-semibold text-slate-800">Rapid Contamination Detection</h3>
                    <p class="text-sm text-slate-600 mt-1">Instantly identify visual contamination indicators in water samples without lab testing.</p>
                </div>
                <div class="p-4 bg-sky-50 rounded-lg">
                    <div class="w-10 h-10 rounded-full bg-sky-100 flex items-center justify-center mb-3">
                        <svg class="w-5 h-5 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                    </div>
                    <h3 class="font-semibold text-slate-800">Infrastructure Monitoring</h3>
                    <p class="text-sm text-slate-600 mt-1">Analyze tank and pipeline images for structural issues, corrosion, and maintenance needs.</p>
                </div>
                <div class="p-4 bg-amber-50 rounded-lg">
                    <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center mb-3">
                        <svg class="w-5 h-5 text-amber-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                    </div>
                    <h3 class="font-semibold text-slate-800">Compliance Documentation</h3>
                    <p class="text-sm text-slate-600 mt-1">Generate AI-powered reports for BIS compliance and Jal Jeevan Mission audits.</p>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { checkAuth, logout } from '/static/js/auth.js';
        checkAuth();
        window.logout = logout;
    </script>
    <script>
        let selectedFile = null;

        async function loadTanks() {
            try {
                const response = await fetch('/api/tanks');
                const data = await response.json();
                const select = document.getElementById('tank-select');
                data.tanks.forEach(tank => {
                    const option = document.createElement('option');
                    option.value = tank.id;
                    option.textContent = tank.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading tanks:', error);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function processFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                return;
            }

            selectedFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('preview-container').classList.remove('hidden');
                document.getElementById('analyze-water-btn').disabled = false;
                document.getElementById('analyze-infra-btn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function analyzeWater() {
            if (!selectedFile) return;
            
            showLoading();
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            const tankId = document.getElementById('tank-select').value;
            if (tankId) formData.append('tank_id', tankId);

            try {
                const response = await fetch('/api/ai/vision/water', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                displayWaterResults(data);
            } catch (error) {
                displayError('Failed to analyze image. Please try again.');
            }
        }

        async function analyzeInfrastructure() {
            if (!selectedFile) return;
            
            showLoading();
            
            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch('/api/ai/vision/infrastructure', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                displayInfraResults(data);
            } catch (error) {
                displayError('Failed to analyze image. Please try again.');
            }
        }

        function showLoading() {
            document.getElementById('results-placeholder').classList.add('hidden');
            document.getElementById('results-content').classList.add('hidden');
            document.getElementById('results-loading').classList.remove('hidden');
        }

        function displayWaterResults(data) {
            document.getElementById('results-loading').classList.add('hidden');
            const container = document.getElementById('results-content');
            container.classList.remove('hidden');

            if (!data.success) {
                container.innerHTML = `<div class="p-4 bg-red-50 rounded-lg text-red-700">${data.error}</div>`;
                return;
            }

            const a = data.analysis;
            const severityClass = `severity-${a.contamination_level || 'none'}`;
            
            container.innerHTML = `
                <div class="p-4 ${severityClass} rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold">Contamination Level</span>
                        <span class="font-bold uppercase">${a.contamination_level || 'None'}</span>
                    </div>
                    <div class="mt-2 text-sm">Confidence: ${Math.round((a.confidence || 0) * 100)}%</div>
                </div>

                ${a.safety_assessment ? `
                <div class="p-4 bg-slate-50 rounded-lg">
                    <h4 class="font-semibold mb-2">Safety Assessment</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span>Safe for Drinking:</span>
                            <span class="${a.safety_assessment.safe_for_drinking ? 'text-emerald-600' : 'text-red-600'} font-medium">
                                ${a.safety_assessment.safe_for_drinking ? 'Yes' : 'No'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span>Safe for Domestic Use:</span>
                            <span class="${a.safety_assessment.safe_for_domestic_use ? 'text-emerald-600' : 'text-red-600'} font-medium">
                                ${a.safety_assessment.safe_for_domestic_use ? 'Yes' : 'No'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span>Requires Treatment:</span>
                            <span class="${a.safety_assessment.requires_treatment ? 'text-amber-600' : 'text-emerald-600'} font-medium">
                                ${a.safety_assessment.requires_treatment ? 'Yes' : 'No'}
                            </span>
                        </div>
                    </div>
                </div>
                ` : ''}

                ${a.visual_indicators && a.visual_indicators.length > 0 ? `
                <div class="p-4 bg-slate-50 rounded-lg">
                    <h4 class="font-semibold mb-2">Visual Indicators</h4>
                    <ul class="space-y-2 text-sm">
                        ${a.visual_indicators.map(i => `
                            <li class="flex items-start gap-2">
                                <span class="px-2 py-0.5 rounded text-xs font-medium ${
                                    i.severity === 'high' ? 'bg-red-100 text-red-700' :
                                    i.severity === 'medium' ? 'bg-amber-100 text-amber-700' :
                                    'bg-slate-200 text-slate-700'
                                }">${i.severity}</span>
                                <span>${i.indicator}: ${i.description}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}

                ${a.immediate_actions && a.immediate_actions.length > 0 ? `
                <div class="p-4 bg-amber-50 rounded-lg">
                    <h4 class="font-semibold mb-2 text-amber-800">Recommended Actions</h4>
                    <ul class="list-disc list-inside text-sm text-amber-900 space-y-1">
                        ${a.immediate_actions.map(action => `<li>${action}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                ${a.summary ? `
                <div class="p-4 bg-sky-50 rounded-lg">
                    <h4 class="font-semibold mb-2 text-sky-800">Summary</h4>
                    <p class="text-sm text-sky-900">${a.summary}</p>
                </div>
                ` : ''}
            `;
        }

        function displayInfraResults(data) {
            document.getElementById('results-loading').classList.add('hidden');
            const container = document.getElementById('results-content');
            container.classList.remove('hidden');

            if (!data.success) {
                container.innerHTML = `<div class="p-4 bg-red-50 rounded-lg text-red-700">${data.error}</div>`;
                return;
            }

            const a = data.analysis;
            const condition = a.infrastructure_assessment?.overall_condition || 'unknown';
            const conditionColors = {
                good: 'bg-emerald-100 text-emerald-800',
                fair: 'bg-amber-100 text-amber-800',
                poor: 'bg-orange-100 text-orange-800',
                critical: 'bg-red-100 text-red-800'
            };

            container.innerHTML = `
                <div class="p-4 ${conditionColors[condition] || 'bg-slate-100'} rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold">Overall Condition</span>
                        <span class="font-bold uppercase">${condition}</span>
                    </div>
                    <div class="mt-2 text-sm">Confidence: ${Math.round((a.infrastructure_assessment?.confidence || 0) * 100)}%</div>
                </div>

                ${a.issues_detected && a.issues_detected.length > 0 ? `
                <div class="p-4 bg-red-50 rounded-lg">
                    <h4 class="font-semibold mb-2 text-red-800">Issues Detected</h4>
                    <ul class="space-y-2 text-sm">
                        ${a.issues_detected.map(i => `
                            <li class="flex items-start gap-2">
                                <span class="px-2 py-0.5 rounded text-xs font-medium ${
                                    i.severity === 'critical' ? 'bg-red-200 text-red-800' :
                                    i.severity === 'major' ? 'bg-orange-200 text-orange-800' :
                                    'bg-amber-200 text-amber-800'
                                }">${i.severity}</span>
                                <span>${i.issue} (${i.location || 'Location unspecified'})</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : '<div class="p-4 bg-emerald-50 rounded-lg text-emerald-800">No major issues detected</div>'}

                ${a.maintenance_needs && a.maintenance_needs.length > 0 ? `
                <div class="p-4 bg-slate-50 rounded-lg">
                    <h4 class="font-semibold mb-2">Maintenance Needs</h4>
                    <ul class="space-y-2 text-sm">
                        ${a.maintenance_needs.map(m => `
                            <li class="flex justify-between items-center">
                                <span>${m.item}</span>
                                <span class="text-slate-600">${m.urgency} - â‚¹${m.estimated_cost_inr?.toLocaleString() || 'N/A'}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}

                ${a.summary ? `
                <div class="p-4 bg-sky-50 rounded-lg">
                    <h4 class="font-semibold mb-2 text-sky-800">Summary</h4>
                    <p class="text-sm text-sky-900">${a.summary}</p>
                </div>
                ` : ''}
            `;
        }

        function displayError(message) {
            document.getElementById('results-loading').classList.add('hidden');
            const container = document.getElementById('results-content');
            container.classList.remove('hidden');
            container.innerHTML = `<div class="p-4 bg-red-50 rounded-lg text-red-700">${message}</div>`;
        }

        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.handleFileSelect = handleFileSelect;
        window.analyzeWater = analyzeWater;
        window.analyzeInfrastructure = analyzeInfrastructure;

        loadTanks();
    </script>
</body>
</html>
